<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beroli CanlÄ± Stok Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #ea4335; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8f9fa; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 450px; margin: 0 auto; }
        h2 { text-align: center; color: var(--primary); font-size: 24px; margin-bottom: 5px; }
        .status-bar { text-align: center; font-size: 13px; margin-bottom: 15px; padding: 5px; border-radius: 20px; }
        .online { background: #e6f4ea; color: var(--success); }
        .offline { background: #fce8e6; color: var(--danger); }
        .card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        input { width: 100%; box-sizing: border-box; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary); }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.97); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #666; font-size: 14px; padding-bottom: 10px; border-bottom: 2px solid #f1f3f4; }
        td { padding: 12px 0; border-bottom: 1px solid #f1f3f4; font-size: 15px; }
        .qty-badge { background: #f1f3f4; padding: 4px 10px; border-radius: 8px; font-weight: bold; }
        .del-btn { color: var(--danger); background: none; border: none; font-size: 14px; width: auto; padding: 5px; }
        #chartContainer { min-height: 200px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“Š Beroli Stok Pro</h2>
    <div id="status" class="status-bar online">ðŸ”„ BaÄŸlantÄ± kuruluyor...</div>

    <div class="card">
        <canvas id="myChart" style="max-height: 250px;"></canvas>
    </div>

    <div class="card">
        <input type="text" id="pName" placeholder="ÃœrÃ¼n AdÄ± (Ã–rn: Elma)" autocomplete="off">
        <input type="number" id="pQty" placeholder="Adet" autocomplete="off">
        <button onclick="addItem()">LÄ°STEYE EKLE</button>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>ÃœrÃ¼n</th>
                    <th>Stok</th>
                    <th>Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody id="list"></tbody>
        </table>
    </div>
</div>

<script>
    // Ortak Havuz BaÄŸlantÄ±sÄ±
    const BIN_ID = "6786c2e8ad19ca34f8ec8a01";
    const API_KEY = "$2a$10$9v1P/C.Y6y5Xh8C0YxXWneUeYV7uV9p8L2Xq9zR7Z6R7Z6R7Z6";
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    let myChart = null;
    let currentProducts = [];

    // Verileri Ä°nternetten Getir
    async function loadData() {
        try {
            const res = await fetch(`${API_URL}/latest`, {
                headers: { "X-Master-Key": API_KEY }
            });
            const data = await res.json();
            currentProducts = data.record.products || [];
            updateUI();
            document.getElementById('status').innerText = "âœ… CanlÄ± BaÄŸlantÄ± Aktif";
            document.getElementById('status').className = "status-bar online";
        } catch (err) {
            document.getElementById('status').innerText = "âŒ BaÄŸlantÄ± HatasÄ±";
            document.getElementById('status').className = "status-bar offline";
        }
    }

    // Verileri Ä°nternete Kaydet
    async function saveData(newList) {
        document.getElementById('status').innerText = "â³ Kaydediliyor...";
        try {
            await fetch(API_URL, {
                method: 'PUT',
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": API_KEY
                },
                body: JSON.stringify({ products: newList })
            });
            await loadData();
        } catch (err) {
            alert("KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu!");
        }
    }

    function updateUI() {
        // Tabloyu GÃ¼ncelle
        const listBody = document.getElementById('list');
        listBody.innerHTML = currentProducts.map((p, i) => `
            <tr>
                <td>${p.name}</td>
                <td><span class="qty-badge">${p.qty}</span></td>
                <td><button class="del-btn" onclick="deleteItem(${i})">Sil</button></td>
            </tr>
        `).join('');

        // GrafiÄŸi GÃ¼ncelle
        const ctx = document.getElementById('myChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        if (currentProducts.length > 0) {
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: currentProducts.map(p => p.name),
                    datasets: [{
                        data: currentProducts.map(p => p.qty),
                        backgroundColor: ['#4285f4', '#34a853', '#fbbc05', '#ea4335', '#a142f4', '#24c1e0']
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }
    }

    async function addItem() {
        const name = document.getElementById('pName').value.trim();
        const qty = parseInt(document.getElementById('pQty').value);
        
        if (!name || isNaN(qty)) {
            alert("LÃ¼tfen Ã¼rÃ¼n adÄ± ve adet girin!");
            return;
        }

        const newList = [...currentProducts, { name, qty }];
        await saveData(newList);
        document.getElementById('pName').value = "";
        document.getElementById('pQty').value = "";
    }

    async function deleteItem(index) {
        const newList = currentProducts.filter((_, i) => i !== index);
        await saveData(newList);
    }

    // BaÅŸlat
    loadData();
    // 10 saniyede bir otomatik yenile (baÅŸkasÄ± bir ÅŸey ekledi mi diye)
    setInterval(loadData, 10000);
</script>

</body>
</html>
